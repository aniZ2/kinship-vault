rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================
    
    // Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Get user ID
    function userId() {
      return request.auth.uid;
    }
    
    // Check if user is a member of a family
    function isMember(familyId) {
      return exists(/databases/$(database)/documents/memberships/$(userId() + '_' + familyId));
    }
    
    // Get membership document for user in a family
    function getMembership(familyId) {
      return get(/databases/$(database)/documents/memberships/$(userId() + '_' + familyId));
    }
    
    // Check role in family
    function hasRole(familyId, role) {
      return isSignedIn() && 
             isMember(familyId) && 
             getMembership(familyId).data.role == role;
    }
    
    // Check if user is owner
    function isOwner(familyId) {
      return hasRole(familyId, 'owner');
    }
    
    // Check if user is admin
    function isAdmin(familyId) {
      return hasRole(familyId, 'admin');
    }
    
    // Check if user is owner or admin
    function isOwnerOrAdmin(familyId) {
      return isSignedIn() && 
             isMember(familyId) && 
             getMembership(familyId).data.role in ['owner', 'admin'];
    }
    
    // Get family document
    function getFamily(familyId) {
      return get(/databases/$(database)/documents/families/$(familyId));
    }
    
    // Check storage limits for family
    function isWithinStorageLimit(familyId) {
      let fam = getFamily(familyId).data;
      let storageUsed = fam.storageUsedBytes != null ? fam.storageUsed : 0;
      let hasPro = fam.subscription != null && fam.subscription.type == 'pro';
      let limit = hasPro ? 999999999999 : 1073741824; // 1GB for free, unlimited for pro
      return storageUsed < limit;
    }
    
    // =========================================================================
    // USER PROFILES
    // =========================================================================
    
    match /users/{uid} {
      // Users can read their own profile
      allow read: if isSignedIn() && userId() == uid;
      
      // Users can update their own profile
      // Cannot change: membershipLimit, subscription fields
      allow update: if isSignedIn() && 
                       userId() == uid &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['membershipLimit', 'subscription', 'stripeCustomerId']);
      
      // Users can create their own profile on signup
      allow create: if isSignedIn() && userId() == uid;
      
      // Users cannot delete their own profile (must be done server-side)
      allow delete: if false;
      
      // User inbox items
      match /inbox/{inboxId} {
        allow read: if isSignedIn() && userId() == uid;
        allow write: if false; // Only server can write inbox items
      }
    }
    
    // =========================================================================
    // FAMILIES
    // =========================================================================
    
    match /families/{familyId} {
      // Members can read family document
      allow read: if isSignedIn() && isMember(familyId);
      
      // Only server can create families (via createFamily function)
      allow create: if false;
      
      // Owners can update family (except sensitive fields)
      // Cannot change: ownerUid, memberCount, ownerCount, adminCount, createdAt
      allow update: if isOwner(familyId) &&
                       !request.resource.data.diff(resource.data).affectedKeys()
                         .hasAny(['ownerUid', 'memberCount', 'ownerCount', 'adminCount', 'createdAt', 'subscription']);
      
      // Only server can delete families (via deleteFamily function)
      allow delete: if false;
      
      // -----------------------------------------------------------------------
      // FAMILY PAGES (Scrapbook Pages)
      // -----------------------------------------------------------------------
      
      match /pages/{pageId} {
        // Members can read pages
        allow read: if isSignedIn() && isMember(familyId);
        
        // Members can create pages if within storage limit
        allow create: if isSignedIn() && 
                         isMember(familyId) && 
                         isWithinStorageLimit(familyId) &&
                         request.resource.data.createdBy == userId() &&
                         request.resource.data.familyId == familyId;
        
        // Owner/Admin can edit any page, or creator can edit their own
        allow update: if isSignedIn() && 
                         isMember(familyId) && 
                         (isOwnerOrAdmin(familyId) || resource.data.createdBy == userId()) &&
                         // Cannot change creator or familyId
                         request.resource.data.createdBy == resource.data.createdBy &&
                         request.resource.data.familyId == resource.data.familyId;
        
        // Owner/Admin can delete pages
        allow delete: if isSignedIn() && isOwnerOrAdmin(familyId);
      }

      // -----------------------------------------------------------------------
      // PENDING UPLOADS (Guest photo uploads requiring moderation)
      // -----------------------------------------------------------------------

      match /pendingUploads/{uploadId} {
        // Owners and admins can read pending uploads
        allow read: if isSignedIn() && isOwnerOrAdmin(familyId);

        // Only server can create pending uploads (via guest-upload API)
        allow create: if false;

        // Owners and admins can update status (approve/reject)
        allow update: if isSignedIn() && isOwnerOrAdmin(familyId);

        // Owners and admins can delete rejected uploads
        allow delete: if isSignedIn() && isOwnerOrAdmin(familyId);
      }

      // -----------------------------------------------------------------------
      // FAMILY QUESTIONS & RESPONSES
      // -----------------------------------------------------------------------
      
      match /questions/{questionId} {
        // Members can read questions
        allow read: if isSignedIn() && isMember(familyId);
        
        // Members can create questions
        allow create: if isSignedIn() && 
                         isMember(familyId) &&
                         request.resource.data.askedBy == userId() &&
                         request.resource.data.familyId == familyId;
        
        // Asker can update their own question
        allow update: if isSignedIn() && 
                         isMember(familyId) && 
                         resource.data.askedBy == userId();
        
        // Owner/Admin can delete questions
        allow delete: if isSignedIn() && isOwnerOrAdmin(familyId);
        
        match /responses/{responseId} {
          // Members can read responses
          allow read: if isSignedIn() && isMember(familyId);
          
          // Elders/Owners can create responses
          allow create: if isSignedIn() && 
                           isMember(familyId) &&
                           request.resource.data.respondedBy == userId();
          
          // Responder can update their own response
          allow update: if isSignedIn() && 
                           isMember(familyId) && 
                           resource.data.respondedBy == userId();
          
          // Owner/Admin can delete responses
          allow delete: if isSignedIn() && isOwnerOrAdmin(familyId);
        }
      }
    }
    
    // =========================================================================
    // MEMBERSHIPS
    // =========================================================================
    
    match /memberships/{membershipId} {
      // Users can read their own memberships
      allow read: if isSignedIn() && resource.data.uid == userId();
      
      // Members of a family can read all memberships for that family
      allow read: if isSignedIn() && isMember(resource.data.familyId);
      
      // Only server can create/update/delete memberships
      // This is handled by joinFamily, leaveFamily, setAdminRoles, transferOwnership functions
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // =========================================================================
    // EVENTS (Future: Separate from families for Event Pack product)
    // =========================================================================
    
    match /events/{eventId} {
      // TODO: Event-specific rules when Event Pack is implemented
      // For now, block all access
      allow read, write: if false;
      
      match /uploads/{uploadId} {
        // TODO: Guest upload rules (no-login QR code flow)
        allow read, write: if false;
      }
    }
    
    // =========================================================================
    // STEWARDS (Legacy/Estate Planning Feature)
    // =========================================================================
    
    match /stewards/{stewardId} {
      // TODO: Steward designation rules
      // For now, block all access
      allow read, write: if false;
    }
    
    // =========================================================================
    // TRANSCRIPTS (Voice/Video Transcription for Search)
    // =========================================================================
    
    match /transcripts/{transcriptId} {
      // TODO: Transcription rules
      // For now, block all access
      allow read, write: if false;
    }
    
    // =========================================================================
    // VIEW TOKENS (Guest read-only access tokens)
    // =========================================================================

    match /viewTokens/{token} {
      // Anyone with the token can read it (for guest view access)
      // Token is the document ID, so if they can fetch it, they have access
      allow read: if true;

      // Only authenticated owners/admins can create view tokens
      // (when approving guest uploads)
      allow create: if isSignedIn() && isOwnerOrAdmin(request.resource.data.familyId);

      // No updates allowed to view tokens
      allow update: if false;

      // Only owners/admins of the family can revoke (delete) view tokens
      allow delete: if isSignedIn() && isOwnerOrAdmin(resource.data.familyId);
    }

    // =========================================================================
    // DENY ALL OTHER COLLECTIONS
    // =========================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
